<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uber | –®–æ—Ñ—å–æ—Ä—Å–∫–∏ –ø–∞–Ω–µ–ª</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/css/style.css') }}">
    <style>
        .driver-grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .status-bar { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-weight: bold; }
        .online { background: #dcfce7; color: #166534; border: 1px solid #22c55e; }
        .offline { background: #fee2e2; color: #991b1b; border: 1px solid #ef4444; }
        .trip-req { background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 5px solid #000; }
        .btn-accept { background: #22c55e; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; width: 100%; font-weight: bold; }
        input { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; }

        #setup-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; width: 400px; text-align: center; }
        .history-item { font-size: 0.85rem; padding: 8px 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
    </style>
</head>
<body style="background: #f4f4f4;">

    <div id="setup-modal">
        <div class="modal-content">
            <h2>üöó –†–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–π –∞–≤—Ç–æ–º–æ–±–∏–ª</h2>
            <p>–¢—Ä—è–±–≤–∞ –¥–∞ –¥–æ–±–∞–≤–∏—à –∫–æ–ª–∞, –∑–∞ –¥–∞ –≤–∏–∂–¥–∞—à –ø–æ—Ä—ä—á–∫–∏.</p>
            <input type="text" id="setup_car" placeholder="–ú–∞—Ä–∫–∞ –∏ –º–æ–¥–µ–ª (–Ω–∞–ø—Ä. BMW 5)">
            <input type="text" id="setup_plate" placeholder="–†–µ–≥. –Ω–æ–º–µ—Ä (–Ω–∞–ø—Ä. –°–í1234–ê–í)">
            <button onclick="registerDriver()" class="btn-auth" style="width: 100%; margin-top: 10px; background: #000; color: #fff; padding: 10px; border: none; border-radius: 6px; cursor: pointer;">–ì–û–¢–û–í–û</button>
        </div>
    </div>

    <nav class="navbar" style="background: #000; padding: 15px; display: flex; justify-content: space-between; align-items: center;">
        <a href="/client" class="logo" style="color: #fff; text-decoration: none; font-weight: bold;">UBER DRIVER</a>
        <div class="nav-links">
            <span id="dr-name" style="color: white; font-weight: bold; margin-right: 15px;"></span>
            <a href="/login" onclick="localStorage.clear()" class="btn-yellow" style="background: #ffc043; padding: 8px 15px; text-decoration: none; color: #000; border-radius: 6px;">–ò–∑—Ö–æ–¥</a>
        </div>
    </nav>

    <div class="container driver-grid">
        <div>
            <div id="status-box" class="status-bar offline">
                <span id="status-text">OFFLINE</span>
                <button onclick="toggleShift()" class="btn-yellow" style="padding: 5px 15px; border: none; cursor: pointer; background: #ffc043; border-radius: 4px;">–°–ú–ï–ù–ò –°–¢–ê–¢–£–°</button>
            </div>

            <div class="card">
                <h3>üîî –ù–∞–ª–∏—á–Ω–∏ –ø–æ—Ä—ä—á–∫–∏</h3>
                <div id="available-trips">–¢—ä—Ä—Å–µ–Ω–µ –Ω–∞ –∑–∞—è–≤–∫–∏...</div>
            </div>

            <div class="card">
                <h3>üìú –ò—Å—Ç–æ—Ä–∏—è –Ω–∞ –∫—É—Ä—Å–æ–≤–µ—Ç–µ</h3>
                <div id="history-list">–ù—è–º–∞ –∑–∞–≤—ä—Ä—à–µ–Ω–∏ –∫—É—Ä—Å–æ–≤–µ.</div>
            </div>
        </div>

        <div>
            <div class="card" style="background: #000; color: #fff; text-align: center;">
                <h3 style="color: #ffc043;">üí∞ –ú–æ—è—Ç –±–∞–ª–∞–Ω—Å</h3>
                <h1 id="balance">0.00 –ª–≤.</h1>
                <p id="total-trips">–ó–∞–≤—ä—Ä—à–µ–Ω–∏ –∫—É—Ä—Å–æ–≤–µ: 0</p>
                <button onclick="loadEarnings()" class="btn-yellow" style="width: 100%; border: none; padding: 10px; margin-top: 10px; cursor: pointer; background: #ffc043; border-radius: 6px;">–û–ë–ù–û–í–ò</button>
            </div>

            <div class="card">
                <h3>üöó –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞ –∫–æ–ª–∞—Ç–∞</h3>
                <input type="number" id="m_price" step="0.1" placeholder="–¶–µ–Ω–∞ –Ω–∞ –∫–º">
                <input type="text" id="m_loc" placeholder="–¢–µ–∫—É—â–∞ –ª–æ–∫–∞—Ü–∏—è">
                <button onclick="updateService()" class="btn-auth" style="width: 100%; margin-top: 10px; background: #000; color: #fff; padding: 10px; border: none; border-radius: 6px; cursor: pointer;">–ó–ê–ü–ê–ó–ò –ü–†–û–ú–ï–ù–ò–¢–ï</button>
            </div>
        </div>
    </div>

    <script>
        var userData = localStorage.getItem('user');
        if (!userData) window.location.href = "/login";

        var user = JSON.parse(userData);
        if (user.role !== 'driver') window.location.href = "/login";
        document.getElementById('dr-name').innerText = user.full_name;

        var driverId = localStorage.getItem('driver_id') || {{ driver_id if driver_id else 'null' }};
        if (driverId === 'null') driverId = null;

        function updateStatusUI(isOnline) {
            var box = document.getElementById('status-box');
            var txt = document.getElementById('status-text');
            if (isOnline) {
                box.className = "status-bar online";
                txt.innerText = "–í –º–æ–º–µ–Ω—Ç–∞ —Å—Ç–µ: ONLINE";
            } else {
                box.className = "status-bar offline";
                txt.innerText = "–í –º–æ–º–µ–Ω—Ç–∞ —Å—Ç–µ: OFFLINE";
            }
        }

        function checkStatus() {
            if (!driverId) return;
            fetch('/search/drivers')
                .then(function(res) { return res.json(); })
                .then(function(data) {
                    var available = data["available drivers"] || [];
                    var isOnline = available.some(function(d) {
                        return String(d.id) === String(driverId);
                    });
                    updateStatusUI(isOnline);
                });
        }

        function validateDriver() {
            if (!driverId) {
                document.getElementById('setup-modal').style.display = 'flex';
                return;
            }

            fetch("/driver/" + driverId + "/earnings")
                .then(function(res) {
                    if (res.status === 404) {
                        document.getElementById('setup-modal').style.display = 'flex';
                    } else {
                        return res.json().then(function(data) {
                            localStorage.setItem('driver_id', driverId);
                            init();
                        });
                    }
                });
        }

        function registerDriver() {
            var car = document.getElementById('setup_car').value;
            var plate = document.getElementById('setup_plate').value;
            if (!car || !plate) return alert("–ü–æ–ø—ä–ª–Ω–∏ –≤—Å–∏—á–∫–∏ –ø–æ–ª–µ—Ç–∞!");

            fetch("/driver/setup?user_id=" + user.id + "&car_model=" + encodeURIComponent(car) + "&license_plate=" + encodeURIComponent(plate), {
                method: 'POST'
            })
            .then(function(res) { return res.json(); })
            .then(function(data) {
                if (data.driver_id) {
                    alert("–ü—Ä–æ—Ñ–∏–ª—ä—Ç –µ –≥–æ—Ç–æ–≤!");
                    driverId = data.driver_id;
                    localStorage.setItem('driver_id', driverId);
                    document.getElementById('setup-modal').style.display = 'none';
                    init();
                } else { alert(data.detail || "–í—ä–∑–Ω–∏–∫–Ω–∞ –≥—Ä–µ—à–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è—Ç–∞."); }
            });
        }

        function toggleShift() {
            if (!driverId) return;
            fetch("/driver/" + driverId + "/shift", { method: 'PATCH' })
                .then(function(res) {
                    if (res.ok) {
                        checkStatus();
                    } else {
                        alert("–ù–µ—É—Å–ø–µ—à–Ω–∞ —Å–º—è–Ω–∞ –Ω–∞ —Å—Ç–∞—Ç—É—Å–∞.");
                    }
                });
        }

        function init() {
            checkStatus();
            loadEarnings();
            loadAvailableTrips();
            loadHistory();
        }

        function loadEarnings() {
            if (!driverId) return;
            fetch("/driver/" + driverId + "/earnings")
                .then(function(res) { return res.json(); })
                .then(function(data) {
                    if (data.balance !== undefined) {
                        document.getElementById('balance').innerText = data.balance.toFixed(2) + " –ª–≤.";
                        document.getElementById('total-trips').innerText = "–ó–∞–≤—ä—Ä—à–µ–Ω–∏ –∫—É—Ä—Å–æ–≤–µ: " + data.trips_count;
                    }
                });
        }

        function loadAvailableTrips() {
            fetch('/trips/available-trips')
                .then(function(res) { return res.json(); })
                .then(function(data) {
                    var container = document.getElementById('available-trips');
                    var trips = data["available trips"] || [];
                    if (trips.length === 0) {
                        container.innerHTML = "<p style='color:#666;'>–ù—è–º–∞ –∞–∫—Ç–∏–≤–Ω–∏ –∑–∞—è–≤–∫–∏.</p>";
                        return;
                    }
                    container.innerHTML = trips.map(function(t) {
                        return '<div class="trip-req">' +
                               '<strong>' + t.pickup_location + ' ‚ûî ' + t.destination + '</strong><br>' +
                               '<small>–¶–µ–Ω–∞: ' + t.final_price + ' –ª–≤. | –ö–∞—Ç: ' + t.car_category + '</small><br>' +
                               '<button onclick="acceptTrip(' + t.id + ')" class="btn-accept" style="margin-top:10px;">–ü–†–ò–ï–ú–ò</button>' +
                               '</div>';
                    }).join('');
                });
        }

        function loadHistory() {
            if (!driverId) return;
            fetch("/driver/" + driverId + "/trips/history")
                .then(function(res) { return res.json(); })
                .then(function(data) {
                    var list = document.getElementById('history-list');
                    if (data.trips && data.trips.length > 0) {
                        list.innerHTML = data.trips.map(function(t) {
                            return '<div class="history-item"><span>üèÅ ' + t.destination + '</span><b>' + t.final_price + ' –ª–≤.</b></div>';
                        }).join('');
                    } else {
                        list.innerHTML = "–ù—è–º–∞ –∑–∞–≤—ä—Ä—à–µ–Ω–∏ –∫—É—Ä—Å–æ–≤–µ.";
                    }
                });
        }

        function acceptTrip(tripId) {
            if (!driverId) return;
            fetch("/trip/" + tripId + "/accept?driver_id=" + driverId, { method: 'PATCH' })
                .then(function(res) {
                    if (res.ok) {
                        alert("–ö—É—Ä—Å—ä—Ç –µ –ø—Ä–∏–µ—Ç!");
                        loadAvailableTrips();
                        loadEarnings();
                        loadHistory();
                    } else {
                        res.json().then(function(d) { alert(d.detail); });
                    }
                });
        }

        function updateService() {
            if (!driverId) return;
            var price = document.getElementById('m_price').value;
            var loc = document.getElementById('m_loc').value;
            fetch("/driver/" + driverId + "/manage-service?price=" + price + "&location=" + encodeURIComponent(loc), { method: 'PUT' })
                .then(function(res) {
                    if (res.ok) alert("–ó–∞–ø–∞–∑–µ–Ω–æ!");
                });
        }

        validateDriver();
        setInterval(loadAvailableTrips, 10000);
    </script>
</body>
</html>